(()=>{"use strict";class t{constructor(){this.TIMER=5,this.init=()=>{this.getUserAccount(),this.addTabSegmentListeners()},this.addMarkers=e=>{const n=e,i=document.querySelector(".markers"),g=this.getVideoTime(t.tabChunks.highEString),r=[];g.forEach((t=>{r.push(t.start)})),i.innerHTML="",r.forEach((t=>{const e=document.createElement("div");e.classList.add("marker");const g=t/n*100;e.style.left=`${g}%`,i.appendChild(e)}))},this.getVideoText=t=>{const e=[];return t.forEach((t=>{e.push(t.text)})),e},this.getVideoTime=t=>{const e=[];return t.forEach((t=>{e.push(t.time)})),e},this.buildTabChunkHTML=()=>{const e=document.createElement("div");e.classList.add("tab-chunk-container");for(let n=0;n<Object.keys(t.tabChunks).length;n++){const i=document.createElement("div");i.id="tab-chunk-"+t.tabChunks.highEString[n].id,i.classList.add("tab-chunk-text");const g=document.createElement("p");g.innerHTML=t.tabChunks.highEString[n].text,i.append(g);const r=document.createElement("p");r.innerHTML=t.tabChunks.bString[n].text,i.append(r);const s=document.createElement("p");s.innerHTML=t.tabChunks.gString[n].text,i.append(s);const h=document.createElement("p");h.innerHTML=t.tabChunks.dString[n].text,i.append(h);const a=document.createElement("p");a.innerHTML=t.tabChunks.aString[n].text,i.append(a);const d=document.createElement("p");d.innerHTML=t.tabChunks.eString[n].text,i.append(d),e.append(i)}return e.outerHTML},this.adjustTabChunkTime=(e,n)=>{const i=e.id.split("-")[2];t.selectedTabChunkId=i,this.addMarkers(n)},this.addTabSegmentListeners=()=>{const e=document.getElementById("start-tab-segment-button"),n=document.getElementById("end-tab-segment-button"),i=document.getElementById("video-timeline");e.addEventListener("click",(()=>{for(let e=0;e<Object.keys(t.tabChunks).length;e++)t.tabChunks.highEString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.highEString[e].time.start=Math.round(parseInt(i.value))),t.tabChunks.bString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.bString[e].time.start=Math.round(parseInt(i.value))),t.tabChunks.gString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.gString[e].time.start=Math.round(parseInt(i.value))),t.tabChunks.dString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.dString[e].time.start=Math.round(parseInt(i.value))),t.tabChunks.aString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.aString[e].time.start=Math.round(parseInt(i.value))),t.tabChunks.eString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.eString[e].time.start=Math.round(parseInt(i.value)));this.initVideoUpload()})),n.addEventListener("click",(()=>{for(let e=0;e<Object.keys(t.tabChunks).length;e++)t.tabChunks.highEString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.highEString[e].time.end=Math.round(parseInt(i.value))),t.tabChunks.bString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.bString[e].time.end=Math.round(parseInt(i.value))),t.tabChunks.gString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.gString[e].time.end=Math.round(parseInt(i.value))),t.tabChunks.dString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.dString[e].time.end=Math.round(parseInt(i.value))),t.tabChunks.aString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.aString[e].time.end=Math.round(parseInt(i.value))),t.tabChunks.eString[e].id===Number(t.selectedTabChunkId)&&(t.tabChunks.eString[e].time.end=Math.round(parseInt(i.value)));this.initVideoUpload()}))},this.initVideoUpload=()=>{const e=document.getElementById("video-editing-tool-container"),n=document.getElementById("video-upload"),i=document.getElementById("video-canvas"),g=i.getContext("2d"),r=document.createElement("video"),s=document.getElementById("video-timeline"),h=document.getElementById("pause-icon"),a=document.getElementById("view-tab-chunks-button"),d=this.getVideoText(t.tab.highEString),l=this.getVideoText(t.tab.bString),o=this.getVideoText(t.tab.gString),S=this.getVideoText(t.tab.dString),u=this.getVideoText(t.tab.aString),c=this.getVideoText(t.tab.eString),b=this.getVideoTime(t.tabChunks.highEString),m=this.getVideoTime(t.tabChunks.bString),p=this.getVideoTime(t.tabChunks.gString),E=this.getVideoTime(t.tabChunks.dString),k=this.getVideoTime(t.tabChunks.aString),T=this.getVideoTime(t.tabChunks.eString);let y=["","","","","",""];function C(t,e,n){const i=r.currentTime;y[n]="",e.forEach(((e,g)=>{i>=e.start&&i<e.end&&(y[n]=t[g])}))}function v(){r.paused||r.ended||(g.clearRect(0,0,i.width,i.height),g.drawImage(r,0,0,i.width,i.height),g.font="48px Monospace",g.fillStyle="white",g.strokeStyle="white",g.lineWidth=2,g.textAlign="left",y.forEach(((t,e)=>{if(t){const n=50,r=i.height-50*(6-e)-100;g.fillText(t,n,r),g.strokeText(t,n,r)}})),requestAnimationFrame(v))}n.addEventListener("change",(t=>{var n;const s=document.getElementById("upload-video-buttons-container"),h=document.getElementById("video-canvas"),d=document.getElementById("video-icon");d.style.display="none",s.style.display="none",h.style.display="block";const l=null===(n=t.target.files)||void 0===n?void 0:n[0];if(l){e.style.display="block";const t=document.getElementById("unmount-video-button");t.style.display="block";let n=!1;a.addEventListener("click",(()=>{const t=document.getElementById("popup-modal");t.innerHTML=this.buildTabChunkHTML();const e=document.getElementsByClassName("tab-chunk-text");if(n)t.style.display="none",n=!1;else{for(let t=0;t<e.length;t++)e[t].addEventListener("click",(()=>{for(let t=0;t<e.length;t++)e[t].classList.remove("tab-segment-selected");e[t].classList.add("tab-segment-selected")}));t.style.display="flex",n=!0}})),t.addEventListener("click",(()=>{null!=r&&(r.pause(),r.removeAttribute("src"),r.load(),g.clearRect(0,0,i.width,i.height),e.style.display="none",h.style.display="none",s.style.display="flex",d.style.display="block")}));const o=URL.createObjectURL(l);r.src=o,r.load(),r.play(),r.muted=!1,r.addEventListener("loadedmetadata",(()=>{i.width=r.videoWidth,i.height=r.videoHeight,this.addMarkers(Number(r.duration.toFixed(0))),requestAnimationFrame(v)}))}})),e.addEventListener("click",(()=>{r.src&&(r.paused?(requestAnimationFrame(v),r.play(),h.style.display="none"):(r.pause(),h.style.display="flex"))})),s.addEventListener("change",(()=>{v()})),s.addEventListener("input",(()=>{const t=Number(s.value)/100*r.duration;Number.isNaN(t)||(r.currentTime=t,g.clearRect(0,0,i.width,i.height),g.drawImage(r,0,0,i.width,i.height),r.pause(),h.style.display="flex")})),r.addEventListener("timeupdate",(()=>{const t=r.currentTime/r.duration*100;s.value=t.toString(),C(d,b,0),C(l,m,1),C(o,p,2),C(S,E,3),C(u,k,4),C(c,T,5)}))},this.getUserAccount=()=>{return e=this,i=function*(){const e=window.location.search,n=new URLSearchParams(e),i=n.get("username"),g=yield fetch("https://guitar-tablature-to-pdf-147ddb720da0.herokuapp.com/getUserAccount?username="+i),r=yield g.json(),s=n.get("title");this.tabTitle=s,this.user=r;const h=this.user.tabs.find((t=>t.tabTitle===s));t.tab=this.splitTabIntoChunks(this.formatTabForPDFExport(h.tabData)),t.tabChunks=this.splitTabIntoChunks(this.formatTabForPDFExport(h.tabData)),this.initVideoUpload()},new((n=void 0)||(n=Promise))((function(t,g){function r(t){try{h(i.next(t))}catch(t){g(t)}}function s(t){try{h(i.throw(t))}catch(t){g(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(r,s)}h((i=i.apply(e,[])).next())}));var e,n,i},this.splitTabIntoChunks=t=>{const e=t.highEString.split(""),n=t.bString.split(""),i=t.gString.split(""),g=t.dString.split(""),r=t.aString.split(""),s=t.eString.split(""),h=[],a=[],d=[],l=[],o=[],S=[],u={highEString:[],bString:[],gString:[],dString:[],aString:[],eString:[]};let c=33,b=this.TIMER;for(let t=0;t<e.length;t++)h.push(e[t]),a.push(n[t]),d.push(i[t]),l.push(g[t]),o.push(r[t]),S.push(s[t]),t!==c&&t!==e.length-1||(u.highEString.push({text:h.join(""),id:t,time:{start:b,end:b+this.TIMER}}),u.bString.push({text:a.join(""),id:t,time:{start:b,end:b+this.TIMER}}),u.gString.push({text:d.join(""),id:t,time:{start:b,end:b+this.TIMER}}),u.dString.push({text:l.join(""),id:t,time:{start:b,end:b+this.TIMER}}),u.aString.push({text:o.join(""),id:t,time:{start:b,end:b+this.TIMER}}),u.eString.push({text:S.join(""),id:t,time:{start:b,end:b+this.TIMER}}),c+=33,b+=this.TIMER,h.splice(0,t),a.splice(0,t),d.splice(0,t),l.splice(0,t),o.splice(0,t),S.splice(0,t));return u},this.formatTabForPDFExport=t=>{const e=this.findLongestString(t),n={highEString:[],bString:[],gString:[],dString:[],aString:[],eString:[]};let i,g,r,s,h,a;"string"==typeof t.highEString?(i=t.highEString.split(""),g=t.bString.split(""),r=t.gString.split(""),s=t.dString.split(""),h=t.aString.split(""),a=t.eString.split("")):(i=t.highEString,g=t.bString,r=t.gString,s=t.dString,h=t.aString,a=t.eString);const d=Math.max(i.length,g.length,r.length,s.length,h.length,a.length);for(let e=0;e<d;e++)void 0===t.highEString[e]&&(t.highEString+="-"),void 0===t.bString[e]&&(t.bString+="-"),void 0===t.gString[e]&&(t.gString+="-"),void 0===t.dString[e]&&(t.dString+="-"),void 0===t.aString[e]&&(t.aString+="-"),void 0===t.eString[e]&&(t.eString+="-");for(let i=0;i<e;i++){const e=t.highEString[i],g=t.bString[i],r=t.gString[i],s=t.dString[i],h=t.aString[i],a=t.eString[i],d=t.highEString[i-1],l=t.bString[i-1],o=t.gString[i-1],S=t.dString[i-1],u=t.aString[i-1],c=t.eString[i-1],b=t.highEString[i+1],m=t.bString[i+1],p=t.gString[i+1],E=t.dString[i+1],k=t.aString[i+1],T=t.eString[i+1];"{"!==e&&(n.highEString.push(e),"{"!==d&&"}"!==b&&"}"!==e&&n.highEString.push("-")),"{"!==g&&(n.bString.push(g),"{"!==l&&"}"!==m&&"}"!==g&&n.bString.push("-")),"{"!==r&&(n.gString.push(r),"{"!==o&&"}"!==p&&"}"!==r&&n.gString.push("-")),"{"!==s&&(n.dString.push(s),"{"!==S&&"}"!==E&&"}"!==s&&n.dString.push("-")),"{"!==h&&(n.aString.push(h),"{"!==u&&"}"!==k&&"}"!==h&&n.aString.push("-")),"{"!==a&&(n.eString.push(a),"{"!==c&&"}"!==T&&"}"!==a&&n.eString.push("-"))}const l=n.highEString.join("").split(""),o=n.bString.join("").split(""),S=n.gString.join("").split(""),u=n.dString.join("").split(""),c=n.aString.join("").split(""),b=n.eString.join("").split(""),m=Math.max(l.length,o.length,S.length,u.length,c.length,b.length);let p={highEString:[],bString:[],gString:[],dString:[],aString:[],eString:[]};for(let t=0;t<m;t++)p.highEString.push(n.highEString[t]||"-"),p.bString.push(n.bString[t]||"-"),p.gString.push(n.gString[t]||"-"),p.dString.push(n.dString[t]||"-"),p.aString.push(n.aString[t]||"-"),p.eString.push(n.eString[t]||"-");p={highEString:p.highEString,bString:p.bString,gString:p.gString,dString:p.dString,aString:p.aString,eString:p.eString};let E=0;for(let t=0;t<p.highEString.length;t++){const e=p.highEString[t]||"-",n=p.bString[t]||"-",i=p.gString[t]||"-",g=p.dString[t]||"-",r=p.aString[t]||"-",s=p.eString[t]||"-";"-"===e&&"-"===n&&"-"===i&&"-"===g&&"-"===r&&"-"===s||(E=t),"}"===e&&(p.highEString[t]="-"),"}"===n&&(p.bString[t]="-"),"}"===i&&(p.gString[t]="-"),"}"===g&&(p.dString[t]="-"),"}"===r&&(p.aString[t]="-"),"}"===s&&(p.eString[t]="-"),"}"!==e&&"}"!==n&&"}"!==i&&"}"!==g&&"}"!==r&&"}"!==s||("}"===e?p.highEString[t]="-":p.highEString.splice(t,0,"-"),"}"===n?p.bString[t]="-":p.bString.splice(t,0,"-"),"}"===i?p.gString[t]="-":p.gString.splice(t,0,"-"),"}"===g?p.dString[t]="-":p.dString.splice(t,0,"-"),"}"===r?p.aString[t]="-":p.aString.splice(t,0,"-"),"}"===s?p.eString[t]="-":p.eString.splice(t,0,"-"))}const k={highEString:p.highEString.slice(0,E+4).join(""),bString:p.bString.slice(0,E+4).join(""),gString:p.gString.slice(0,E+4).join(""),dString:p.dString.slice(0,E+4).join(""),aString:p.aString.slice(0,E+4).join(""),eString:p.eString.slice(0,E+4).join("")},T=document.getElementById("tab-text-highEString"),y=document.getElementById("tab-text-bString"),C=document.getElementById("tab-text-gString"),v=document.getElementById("tab-text-dString"),I=document.getElementById("tab-text-aString"),M=document.getElementById("tab-text-eString");return T.innerHTML=p.highEString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),y.innerHTML=p.bString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),C.innerHTML=p.gString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),v.innerHTML=p.dString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),I.innerHTML=p.aString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),M.innerHTML=p.eString.slice(0,Math.min(p.highEString.length,p.bString.length,p.gString.length,p.dString.length,p.aString.length,p.eString.length)).join(""),k},this.findLongestString=t=>{const e={stringName:"",stringLength:0};return Object.entries(t).forEach((t=>{const n=t[0],i=t[1].length;i>e.stringLength&&(e.stringName=n,e.stringLength=i)})),e.stringLength},this.user={},this.tabTitle=""}}(new t).init()})();